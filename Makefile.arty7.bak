PROJ=chip_balls
PINOUT=Arty-A7-100-Master.xdc

NEXTPNR_XILINX_DIR ?= /snap/openxc7/current/opt/nextpnr-xilinx
NEXTPNR_XILINX_PYTHON_DIR ?= ${NEXTPNR_XILINX_DIR}/python
PRJXRAY_DB_DIR ?= ${NEXTPNR_XILINX_DIR}/external/prjxray-db

DBPART = $(shell echo ${PART} | sed -e 's/-[0-9]//g')
SPEEDGRADE = $(shell echo ${PART} | sed -e 's/.*\-\([0-9]\)/\1/g')

CHIPDB ?= ./chipdb/
PYPY3 ?= pypy3

RM            = rm -rf
VERILOG_FILES = chip_balls.v \
								tmds_encoder.v \
								my_vga_clk_generator.v \
								ball.v \
								hdmi_device.v \
								lfsr.v\

all: ${PROJ}.bit

%.json: %.v
	yosys -DARTY7 -p "synth_xilinx -flatten -abc9 -nobram -arch xc7 -top ${PROJ}; write_json ${PROJ}.json" ${VERILOG_FILES}

%place_route: %.json
#	nextpnr-ecp5 --json $< --textcfg $@ --85k --package CABGA381 --lpf ulx3s_v20.lpf
	nextpnr-xilinx --timing-allow-fail --freq 250 --chipdb ${NEXTPNR_XILINX_DB}/xc7a100t.bin --xdc ${PINOUT} --json ${PROJ}.json --write ${PROJ}_routed.json --fasm ${PROJ}.fasm

%.bit: %place_route
	#./build_arty7.sh ${PROJ}
	${PYPY3} ${NEXTPNR_XILINX_PYTHON_DIR}/bbaexport.py --device ${PART} --bba ${DBPART}.bba
	bbasm -l ${DBPART}.bba ${CHIPDB}/${DBPART}.bin
	
prog: ${PROJ}.bit
	xc3sprog -c nexys4 $<

clean:
	$(RM) -f ${PROJ}.bit ${PROJ}.json ${PROJ}.fasm ${PROJ}.frame

.PHONY: prog clean
